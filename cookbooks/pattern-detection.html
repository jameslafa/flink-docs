<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Apache Flink 1.4-SNAPSHOT Documentation: Pattern Detection with CEP</title>
    <link rel="shortcut icon" href="/page/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/page/favicon.ico" type="image/x-icon">

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="/page/css/flink.css">
    <link rel="stylesheet" href="/page/css/syntax.css">
    <link rel="stylesheet" href="/page/css/codetabs.css">
    <link rel="stylesheet" href="/page/font-awesome/css/font-awesome.min.css">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    

    <!-- Main content. -->
    <div class="container">
      
      <div class="row">
        <div class="col-lg-3" id="sidenavcol">
          







  
    
    
    
      
    
  

  
    
    
    
      









  





<div class="sidenav-logo">
  <p><a href=""><img class="bottom" alt="Apache Flink" src="/page/img/navbar-brand-logo.jpg"></a> v1.4-SNAPSHOT</p>
</div>
<ul id="sidenav">

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/index.html"><i class="fa fa-home title" aria-hidden="true"></i> Home</a></li>
    
  

  
    

    
      
    

    
    
    

    <hr class="section-break"></hr>

    
    
      
      
        
        
<li><a href="#collapse-2" data-toggle="collapse"><i class="fa fa-map-o title appetizer" aria-hidden="true"></i> Concepts <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-2"><ul>
  
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
<li><a href="/concepts/programming-model.html">Programming Model</a></li>
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/concepts/runtime.html">Distributed Runtime</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/quickstart/setup_quickstart.html"><i class="fa fa-power-off title appetizer" aria-hidden="true"></i> Quickstart</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-7" data-toggle="collapse"><i class="fa fa-file-code-o title appetizer" aria-hidden="true"></i> Examples <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-7"><ul>
  <li><a href="/examples/index.html">Overview</a></li>
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/quickstart/run_example_quickstart.html">Monitoring Wikipedia Edits</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/batch/examples.html">Batch Examples</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-11" data-toggle="collapse" class="active"><i class="fa fa-book title appetizer" aria-hidden="true"></i> Cookbooks</a><div class="collapse in" id="collapse-11"><ul>
  
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
<li><a href="/cookbooks/join-streams.html">Join Streams</a></li>
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
<li><a href="/cookbooks/pattern-detection.html" class="active">Pattern Detection with CEP</a></li>
      
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    <hr class="section-break"></hr>

    
    
      
      
        
        
<li><a href="#collapse-15" data-toggle="collapse"><i class="fa fa-cogs title maindish" aria-hidden="true"></i> Project Setup <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-15"><ul>
  
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/quickstart/java_api_quickstart.html">Sample Project in Java</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/quickstart/scala_api_quickstart.html">Sample Project in Scala</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/linking_with_flink.html">Linking with Flink</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/internals/ide_setup.html">IDE Setup</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/scala_shell.html">Scala REPL</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/linking.html">Linking with Optional Modules</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/start/flink_on_windows.html">Running Flink on Windows</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/start/building.html">Building Flink from Source</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-25" data-toggle="collapse"><i class="fa fa-code title maindish" aria-hidden="true"></i> Application Development <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-25"><ul>
  
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-26" data-toggle="collapse">Basic API Concepts <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-26"><ul>
  <li><a href="/dev/api_concepts.html">Overview</a></li>
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/scala_api_extensions.html">Scala API Extensions</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/java8.html">Java 8</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-30" data-toggle="collapse">Streaming (DataStream API) <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-30"><ul>
  <li><a href="/dev/datastream_api.html">Overview</a></li>
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-31" data-toggle="collapse">Event Time <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-31"><ul>
  <li><a href="/dev/event_time.html">Overview</a></li>
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/event_timestamps_watermarks.html">Generating Timestamps / Watermarks</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/event_timestamp_extractors.html">Pre-defined Timestamp Extractors / Watermark Emitters</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-35" data-toggle="collapse">State & Fault Tolerance <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-35"><ul>
  <li><a href="/dev/stream/state/index.html">Overview</a></li>
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/stream/state/state.html">Working with State</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/stream/state/checkpointing.html">Checkpointing</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/stream/state/queryable_state.html">Queryable State</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/stream/state/state_backends.html">State Backends</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/stream/state/custom_serialization.html">Custom Serialization</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-42" data-toggle="collapse">Operators <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-42"><ul>
  <li><a href="/dev/stream/operators/index.html">Overview</a></li>
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
<li><a href="/dev/stream/operators/windows.html">Windows</a></li>
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/stream/operators/process_function.html">Process Function</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/stream/operators/asyncio.html">Async I/O</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-47" data-toggle="collapse">Connectors <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-47"><ul>
  <li><a href="/dev/connectors/index.html">Overview</a></li>
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/connectors/guarantees.html">Fault Tolerance Guarantees</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/connectors/kafka.html">Kafka</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/connectors/cassandra.html">Cassandra</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/connectors/kinesis.html">Kinesis</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/connectors/elasticsearch.html">Elasticsearch</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/connectors/filesystem_sink.html">Rolling File Sink</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/connectors/rabbitmq.html">RabbitMQ</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/connectors/nifi.html">NiFi</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/connectors/twitter.html">Twitter</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/stream/side_output.html">Side Outputs</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
<li><a href="/dev/stream/testing.html">Testing</a></li>
      
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-61" data-toggle="collapse">Batch (DataSet API) <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-61"><ul>
  <li><a href="/dev/batch/index.html">Overview</a></li>
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/batch/dataset_transformations.html">Transformations</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/batch/iterations.html">Iterations</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/batch/zip_elements_guide.html">Zipping Elements</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/batch/fault_tolerance.html">Fault Tolerance</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/batch/python.html">Python API</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/batch/connectors.html">Connectors</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/batch/hadoop_compatibility.html">Hadoop Compatibility</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/local_execution.html">Local Execution</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/cluster_execution.html">Cluster Execution</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-72" data-toggle="collapse">Table API & SQL <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-72"><ul>
  <li><a href="/dev/table/index.html">Overview</a></li>
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/table/common.html">Concepts & Common API</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/table/streaming.html">Streaming Concepts</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/table/tableApi.html">Table API</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/table/sql.html">SQL</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/table/sourceSinks.html">Table Sources & Sinks</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/table/udfs.html">User-defined Functions</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-80" data-toggle="collapse">Data Types & Serialization <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-80"><ul>
  <li><a href="/dev/types_serialization.html">Overview</a></li>
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/custom_serializers.html">Custom Serializers</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-83" data-toggle="collapse">Managing Execution <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-83"><ul>
  
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/execution_configuration.html">Execution Configuration</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/packaging.html">Program Packaging</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/parallel.html">Parallel Execution</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/execution_plans.html">Execution Plans</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/restart_strategies.html">Restart Strategies</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-90" data-toggle="collapse">Libraries <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-90"><ul>
  
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/libs/cep.html">Event Processing (CEP)</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/libs/storm_compatibility.html">Storm Compatibility</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-93" data-toggle="collapse">Graphs: Gelly <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-93"><ul>
  <li><a href="/dev/libs/gelly/index.html">Overview</a></li>
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/libs/gelly/graph_api.html">Graph API</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/libs/gelly/iterative_graph_processing.html">Iterative Graph Processing</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/libs/gelly/library_methods.html">Library Methods</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/libs/gelly/graph_algorithms.html">Graph Algorithms</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/libs/gelly/graph_generators.html">Graph Generators</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/libs/gelly/bipartite_graph.html">Bipartite Graph</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-101" data-toggle="collapse">Machine Learning <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-101"><ul>
  <li><a href="/dev/libs/ml/index.html">Overview</a></li>
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/libs/ml/quickstart.html">Quickstart</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/libs/ml/multiple_linear_regression.html">Multiple Linear Regression</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/libs/ml/cross_validation.html">Cross Validation</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/libs/ml/distance_metrics.html">Distance Metrics</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/libs/ml/knn.html">k-Nearest Neighbors Join</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/libs/ml/min_max_scaler.html">MinMax Scaler</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/libs/ml/contribution_guide.html">How to Contribute</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/libs/ml/pipelines.html">Pipelines</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/libs/ml/polynomial_features.html">Polynomial Features</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/libs/ml/als.html">ALS</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/libs/ml/sos.html">Stochastic Outlier Selection</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/libs/ml/standard_scaler.html">Standard Scaler</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/libs/ml/svm.html">SVM using CoCoA</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/best_practices.html">Best Practices</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/dev/migration.html">API Migration Guides</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-120" data-toggle="collapse"><i class="fa fa-sliders title maindish" aria-hidden="true"></i> Deployment & Operations <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-120"><ul>
  
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-121" data-toggle="collapse">Clusters & Deployment <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-121"><ul>
  
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/ops/deployment/cluster_setup.html">Standalone Cluster</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/ops/deployment/yarn_setup.html">YARN</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/ops/deployment/mesos.html">Mesos</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/ops/deployment/docker.html">Docker</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/ops/deployment/kubernetes.html">Kubernetes</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/ops/deployment/aws.html">AWS</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/ops/deployment/gce_setup.html">Google Compute Engine</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/ops/deployment/mapr_setup.html">MapR</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/ops/jobmanager_high_availability.html">High Availability (HA)</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-132" data-toggle="collapse">State & Fault Tolerance <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-132"><ul>
  
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/ops/state/checkpoints.html">Checkpoints</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/ops/state/savepoints.html">Savepoints</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/ops/state/state_backends.html">State Backends</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/ops/state/large_state_tuning.html">Tuning Checkpoints and Large State</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
<li><a href="/ops/config.html">Configuration</a></li>
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/ops/production_ready.html">Production Readiness Checklist</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/ops/cli.html">CLI</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/ops/security-kerberos.html">Kerberos</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/ops/security-ssl.html">SSL Setup</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/ops/upgrading.html">Upgrading Applications and Flink Versions</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    

    
    
      
      
        
        
<li><a href="#collapse-145" data-toggle="collapse"><i class="fa fa-bug title maindish" aria-hidden="true"></i> Debugging & Monitoring <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-145"><ul>
  
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/monitoring/metrics.html">Metrics</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/monitoring/logging.html">Logging</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/monitoring/historyserver.html">History Server</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/monitoring/checkpoint_monitoring.html">Monitoring Checkpointing</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/monitoring/back_pressure.html">Monitoring Back Pressure</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/monitoring/rest_api.html">Monitoring REST API</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/monitoring/debugging_event_time.html">Debugging Windows & Event Time</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/monitoring/debugging_classloading.html">Debugging Classloading</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/monitoring/application_profiling.html">Application Profiling</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    

    
      
    

    
    
    

    <hr class="section-break"></hr>

    
    
      
      
        
        
<li><a href="#collapse-156" data-toggle="collapse"><i class="fa fa-book title dessert" aria-hidden="true"></i> Internals <i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-156"><ul>
  
        
        
        

        
        
      
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/internals/components.html">Component Stack</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/internals/stream_checkpointing.html">Fault Tolerance for Data Streaming</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/internals/job_scheduling.html">Jobs and Scheduling</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/internals/task_lifecycle.html">Task Lifecycle</a></li>
    
  

  
    

    
      
    

    
    
    

    

    
    
<li><a href="/internals/filesystems.html">File Systems</a></li>
    
  

  
    
      
      
</li></ul></div>
      
      
    
  

  
    
      
  <li class="divider"></li>
  <li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.4/api/java"><i class="fa fa-external-link title" aria-hidden="true"></i> Javadocs</a></li>
  <li><a href="http://flink.apache.org"><i class="fa fa-external-link title" aria-hidden="true"></i> Project Page</a></li>
</ul>

<div class="sidenav-search-box">
  <form class="navbar-form" role="search" action="/search-results.html">
    <div class="form-group">
      <input type="text" class="form-control" size="16px" name="q" placeholder="Search">
    </div>
    <button type="submit" class="btn btn-default">Go</button>
  </form>
</div>

<div class="sidenav-versions">
  <div class="dropdown">
    <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">Pick Docs Version
    <span class="caret"></span></button>
    <ul class="dropdown-menu">
      
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.3">v1.3</a></li>
      
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.2">v1.2</a></li>
      
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.1">v1.1</a></li>
      
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.0">v1.0</a></li>
      
    </ul>
  </div>
</div>

        </div>
        <div class="col-lg-9 content" id="contentcol">
          

          





  
  
    
    
      
    
  

  
  
    
    
      



<ol class="breadcrumb">

  
  
    <li><i class="fa fa-book title appetizer" aria-hidden="true"></i> Cookbooks</li>
  

  
  
    <li class="active">Pattern Detection with CEP</li>
  

</ol>

<h1>Pattern Detection with CEP</h1>




<ul id="markdown-toc">
  <li><a href="#problem" id="markdown-toc-problem">Problem</a></li>
  <li><a href="#use-case" id="markdown-toc-use-case">Use case</a></li>
  <li><a href="#implementation" id="markdown-toc-implementation">Implementation</a>    <ul>
      <li><a href="#add-the-cep-library" id="markdown-toc-add-the-cep-library">1. Add the CEP library</a></li>
      <li><a href="#create-a-pattern" id="markdown-toc-create-a-pattern">2. Create a pattern</a></li>
      <li><a href="#apply-pattern-and-match-patterns" id="markdown-toc-apply-pattern-and-match-patterns">3. Apply pattern and match patterns</a></li>
    </ul>
  </li>
  <li><a href="#full-source-code" id="markdown-toc-full-source-code">Full source code</a></li>
</ul>

<h2 id="problem">Problem</h2>

<p>Many use cases require detecting a pattern in data streams:</p>

<ul>
  <li>detect authentication brute force (multiple failed authentication attempts in a raw);</li>
  <li>detect unusual activity in application/network logs to anticipate a potential attack;</li>
  <li>detect users starting a process in an application and stopping in the middle (new signups, etc.);</li>
  <li>detect fraudulent financial operations,</li>
  <li>etc.</li>
</ul>

<p>Detecting such patterns may require complex developments. Flink’s Complex Event Processing (CEP) library has been built to solve these specific problems and simplify these developments. We define a pattern with a few lines of code and Flink’s engine applies the pattern detection on the data stream to match every relevant event.</p>

<h2 id="use-case">Use case</h2>

<p>When a bank’s client uses his credit card, the terminal asks first for authorization to the bank. The bank must as fast as possible evaluate if this operation seems to be legitimate or not. An operation is considered legitimate if it doesn’t match any pattern of fraudulent activity. If the operation is considered illegitimate the bank will block it and maybe notify the card owner as soon as possible.</p>

<p>The pattern we are going to illustrate is two operations made at a distance that the client couldn’t have traveled to in the amount of time separating these operations.</p>

<p>To keep things simple in this cookbook we will consider that bank’s clients cannot travel faster than 200 Km/h. If two operations are made at a distance requiring that the client traveled faster than 200 Km/h the pattern will match the operation and raise an alert.</p>

<h2 id="implementation">Implementation</h2>

<h3 id="add-the-cep-library">1. Add the CEP library</h3>

<p>The CEP library must be added as a dependency. Add in your pom.xml</p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.apache.flink<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>flink-cep_2.10<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.3.2<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre></div>

<p>Your IDE should detect the new dependency automatically. You can also execute in your console <code>mvn clean package</code> if you do not use any.</p>

<h3 id="create-a-pattern">2. Create a pattern</h3>

<p>First, we recommend you to read the <a href="/dev/libs/cep.html">CEP Flink Documentation</a> to discover all possible pattern operations and conditions available in the CEP.</p>

<p>Our pattern is the following: two credit card operations in a raw have been made at an unreachable distance. Using credit card operations’ timestamps and the distance between the cities, we calculate the speed necessary to travel between these two places in that amount of time. If it exceeds 200 Km/h, we consider that it is a fraudulent operation and we match it.</p>

<p>Our pattern starts with any credit card operation, so we do not filter the <em>begin</em> operator with a <em>where</em> clause.</p>

<p>To calculate the traveling speed, we need information about the current credit card operation and the previous one. Using an <em>IterativeCondition</em>, we can access retrieve this information from the context.</p>

<p>We use the <em>next</em> operator to match a credit card operation with the following one.</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Pattern</span><span class="o">&lt;</span><span class="n">CreditCardOperation</span><span class="o">,</span> <span class="n">CreditCardOperation</span><span class="o">&gt;</span> <span class="n">fraudulentOperationPattern</span> <span class="o">=</span>
  <span class="n">Pattern</span><span class="o">.&lt;</span><span class="n">CreditCardOperation</span><span class="o">&gt;</span><span class="n">begin</span><span class="o">(</span><span class="s">&quot;start&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="s">&quot;unreachableDistance&quot;</span><span class="o">).</span><span class="na">where</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">IterativeCondition</span><span class="o">&lt;</span><span class="n">CreditCardOperation</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">filter</span><span class="o">(</span><span class="n">CreditCardOperation</span> <span class="n">currentOperation</span><span class="o">,</span> <span class="n">Context</span><span class="o">&lt;</span><span class="n">CreditCardOperation</span><span class="o">&gt;</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
          <span class="n">Iterator</span> <span class="n">eventsIterator</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">getEventsForPattern</span><span class="o">(</span><span class="s">&quot;start&quot;</span><span class="o">).</span><span class="na">iterator</span><span class="o">();</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">eventsIterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">CreditCardOperation</span> <span class="n">previousOperation</span> <span class="o">=</span> <span class="o">(</span><span class="n">CreditCardOperation</span><span class="o">)</span> <span class="n">eventsIterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="k">return</span> <span class="o">!</span><span class="n">DistanceCalculator</span><span class="o">.</span><span class="na">isReachableDistance</span><span class="o">(</span><span class="n">previousOperation</span><span class="o">,</span> <span class="n">currentOperation</span><span class="o">,</span> <span class="mi">200</span><span class="o">);</span> <span class="c1">// 200 Km/h</span>
          <span class="o">}</span>
          <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">});</span></code></pre></div>

<h3 id="apply-pattern-and-match-patterns">3. Apply pattern and match patterns</h3>

<p>We now have a defined the pattern and we can apply it on a stream to match patterns. We will also define a time window in which the pattern must occur. In our case, we will use 24 hours.</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// Simulated credit card operations stream</span>
<span class="n">DataStream</span><span class="o">&lt;</span><span class="n">CreditCardOperation</span><span class="o">&gt;</span> <span class="n">creditCardOperationDataStream</span> <span class="o">=</span> <span class="n">creditCardOperationSource</span><span class="o">(</span><span class="n">env</span><span class="o">);</span>

<span class="n">PatternStream</span><span class="o">&lt;</span><span class="n">CreditCardOperation</span><span class="o">&gt;</span> <span class="n">patternStream</span> <span class="o">=</span> <span class="n">CEP</span><span class="o">.</span><span class="na">pattern</span><span class="o">(</span><span class="n">creditCardOperationDataStream</span><span class="o">,</span> <span class="n">fraudulentOperationPattern</span><span class="o">.</span><span class="na">within</span><span class="o">(</span><span class="n">Time</span><span class="o">.</span><span class="na">hours</span><span class="o">(</span><span class="mi">24</span><span class="o">)));</span></code></pre></div>

<p>The returned PatternStream contains credit card operations which have matched our pattern. In this example, they will be the potential fraudulent ones that need to be blocked and raise an alert for.</p>

<p>We need to select credit card operations in the PatternStream to generate an alert. In this example, we will only print the fraudulent operations but in a real case, we’ll have to block the operation.</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">DataStream</span><span class="o">&lt;</span><span class="n">Alert</span><span class="o">&gt;</span> <span class="n">alerts</span> <span class="o">=</span> <span class="n">patternStream</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="k">new</span> <span class="n">PatternSelectFunction</span><span class="o">&lt;</span><span class="n">CreditCardOperation</span><span class="o">,</span> <span class="n">Alert</span><span class="o">&gt;()</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Alert</span> <span class="nf">select</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">CreditCardOperation</span><span class="o">&gt;&gt;</span> <span class="n">pattern</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">Iterator</span> <span class="n">patternIterator</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;unreachableDistance&quot;</span><span class="o">).</span><span class="na">iterator</span><span class="o">();</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">patternIterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">Alert</span><span class="o">.</span><span class="na">createFromOperation</span><span class="o">((</span><span class="n">CreditCardOperation</span><span class="o">)</span> <span class="n">patternIterator</span><span class="o">.</span><span class="na">next</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">});</span>

<span class="n">alerts</span><span class="o">.</span><span class="na">print</span><span class="o">();</span></code></pre></div>

<h2 id="full-source-code">Full source code</h2>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">flink</span><span class="o">.</span><span class="na">cookbook</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.flink.api.java.tuple.Tuple2</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.cep.CEP</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.cep.PatternSelectFunction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.cep.PatternStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.cep.pattern.Pattern</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.cep.pattern.conditions.IterativeCondition</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.streaming.api.TimeCharacteristic</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.streaming.api.datastream.DataStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.streaming.api.environment.StreamExecutionEnvironment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.streaming.api.functions.timestamps.BoundedOutOfOrdernessTimestampExtractor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.streaming.api.windowing.time.Time</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.joda.time.DateTime</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PatternDetection</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">userIds</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[])</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

        <span class="c1">// set up streaming execution environment</span>
        <span class="n">StreamExecutionEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="n">StreamExecutionEnvironment</span><span class="o">.</span><span class="na">getExecutionEnvironment</span><span class="o">();</span>
        <span class="n">env</span><span class="o">.</span><span class="na">setStreamTimeCharacteristic</span><span class="o">(</span><span class="n">TimeCharacteristic</span><span class="o">.</span><span class="na">EventTime</span><span class="o">);</span>

        <span class="n">Pattern</span><span class="o">&lt;</span><span class="n">CreditCardOperation</span><span class="o">,</span> <span class="n">CreditCardOperation</span><span class="o">&gt;</span> <span class="n">fraudulentOperationPattern</span> <span class="o">=</span>
            <span class="c1">// We do not add any where clause on &quot;start&quot;, we want to capture every operation</span>
            <span class="n">Pattern</span><span class="o">.&lt;</span><span class="n">CreditCardOperation</span><span class="o">&gt;</span><span class="n">begin</span><span class="o">(</span><span class="s">&quot;start&quot;</span><span class="o">)</span>
                <span class="c1">// We want to compare the current operation with the previous one. We use the next operator</span>
                <span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="s">&quot;unreachableDistance&quot;</span><span class="o">).</span><span class="na">where</span><span class="o">(</span>
                <span class="k">new</span> <span class="n">IterativeCondition</span><span class="o">&lt;</span><span class="n">CreditCardOperation</span><span class="o">&gt;()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">filter</span><span class="o">(</span><span class="n">CreditCardOperation</span> <span class="n">currentOperation</span><span class="o">,</span> <span class="n">Context</span><span class="o">&lt;</span><span class="n">CreditCardOperation</span><span class="o">&gt;</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
                        <span class="c1">// We want to check if the compare if the current operation is at a reachable distance. If not, it&#39;s</span>
                        <span class="c1">// a match and it will raise an alert.</span>
                        <span class="n">Iterator</span> <span class="n">eventsIterator</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">getEventsForPattern</span><span class="o">(</span><span class="s">&quot;start&quot;</span><span class="o">).</span><span class="na">iterator</span><span class="o">();</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">eventsIterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                            <span class="n">CreditCardOperation</span> <span class="n">previousOperation</span> <span class="o">=</span> <span class="o">(</span><span class="n">CreditCardOperation</span><span class="o">)</span> <span class="n">eventsIterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                            <span class="c1">// We match every operation where the user would have had to travel faster than</span>
                            <span class="c1">// 200 km/h to be able to make them.</span>
                            <span class="k">return</span> <span class="o">!</span><span class="n">DistanceCalculator</span><span class="o">.</span><span class="na">isReachableDistance</span><span class="o">(</span><span class="n">previousOperation</span><span class="o">,</span> <span class="n">currentOperation</span><span class="o">,</span> <span class="mi">200</span><span class="o">);</span>
                        <span class="o">}</span>
                        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">});</span>

        <span class="c1">// Simulated credit card operations stream</span>
        <span class="n">DataStream</span><span class="o">&lt;</span><span class="n">CreditCardOperation</span><span class="o">&gt;</span> <span class="n">creditCardOperationDataStream</span> <span class="o">=</span> <span class="n">creditCardOperationSource</span><span class="o">(</span><span class="n">env</span><span class="o">);</span>

        <span class="n">PatternStream</span><span class="o">&lt;</span><span class="n">CreditCardOperation</span><span class="o">&gt;</span> <span class="n">patternStream</span> <span class="o">=</span> <span class="n">CEP</span><span class="o">.</span><span class="na">pattern</span><span class="o">(</span><span class="n">creditCardOperationDataStream</span><span class="o">,</span> <span class="n">fraudulentOperationPattern</span><span class="o">.</span><span class="na">within</span><span class="o">(</span><span class="n">Time</span><span class="o">.</span><span class="na">hours</span><span class="o">(</span><span class="mi">24</span><span class="o">)));</span>
        <span class="n">DataStream</span><span class="o">&lt;</span><span class="n">Alert</span><span class="o">&gt;</span> <span class="n">alerts</span> <span class="o">=</span> <span class="n">patternStream</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="k">new</span> <span class="n">PatternSelectFunction</span><span class="o">&lt;</span><span class="n">CreditCardOperation</span><span class="o">,</span> <span class="n">Alert</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Alert</span> <span class="nf">select</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">CreditCardOperation</span><span class="o">&gt;&gt;</span> <span class="n">pattern</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
                <span class="n">Iterator</span> <span class="n">patternIterator</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;unreachableDistance&quot;</span><span class="o">).</span><span class="na">iterator</span><span class="o">();</span>

                <span class="k">if</span> <span class="o">(</span><span class="n">patternIterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="n">Alert</span><span class="o">.</span><span class="na">createFromOperation</span><span class="o">((</span><span class="n">CreditCardOperation</span><span class="o">)</span> <span class="n">patternIterator</span><span class="o">.</span><span class="na">next</span><span class="o">());</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">});</span>

        <span class="n">alerts</span><span class="o">.</span><span class="na">print</span><span class="o">();</span>

        <span class="n">env</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">&quot;Pattern detection&quot;</span><span class="o">);</span>

    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * DataStream source generating CreditCardOperations.</span>
<span class="cm">     * @param env</span>
<span class="cm">     * @return a DataStream of CreditCardOperations</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">DataStream</span><span class="o">&lt;</span><span class="n">CreditCardOperation</span><span class="o">&gt;</span> <span class="nf">creditCardOperationSource</span><span class="o">(</span><span class="n">StreamExecutionEnvironment</span> <span class="n">env</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">CreditCardOperation</span><span class="o">&gt;</span> <span class="n">ccOps</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">CreditCardOperation</span><span class="o">&gt;();</span>
        <span class="n">DateTime</span> <span class="n">beginTS</span> <span class="o">=</span> <span class="n">DateTime</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>

        <span class="c1">// User 1</span>
        <span class="n">ccOps</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">CreditCardOperation</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mf">100.0f</span><span class="o">,</span> <span class="n">beginTS</span><span class="o">.</span><span class="na">plusMinutes</span><span class="o">(</span><span class="mi">5</span><span class="o">).</span><span class="na">getMillis</span><span class="o">(),</span> <span class="s">&quot;BERLIN&quot;</span><span class="o">));</span>
        <span class="n">ccOps</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">CreditCardOperation</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mf">68.12f</span><span class="o">,</span> <span class="n">beginTS</span><span class="o">.</span><span class="na">plusMinutes</span><span class="o">(</span><span class="mi">15</span><span class="o">).</span><span class="na">getMillis</span><span class="o">(),</span> <span class="s">&quot;BERLIN&quot;</span><span class="o">));</span>
        <span class="c1">// 875 km in 45 min =&gt; Fraud</span>
        <span class="n">ccOps</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">CreditCardOperation</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mf">200.0f</span><span class="o">,</span> <span class="n">beginTS</span><span class="o">.</span><span class="na">plusMinutes</span><span class="o">(</span><span class="mi">60</span><span class="o">).</span><span class="na">getMillis</span><span class="o">(),</span> <span class="s">&quot;PARIS&quot;</span><span class="o">));</span>

        <span class="c1">// User 2</span>
        <span class="n">ccOps</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">CreditCardOperation</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mf">33.99f</span><span class="o">,</span> <span class="n">beginTS</span><span class="o">.</span><span class="na">plusMinutes</span><span class="o">(</span><span class="mi">120</span><span class="o">).</span><span class="na">getMillis</span><span class="o">(),</span> <span class="s">&quot;PARIS&quot;</span><span class="o">));</span>
        <span class="n">ccOps</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">CreditCardOperation</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mf">224.50f</span><span class="o">,</span> <span class="n">beginTS</span><span class="o">.</span><span class="na">plusMinutes</span><span class="o">(</span><span class="mi">130</span><span class="o">).</span><span class="na">getMillis</span><span class="o">(),</span> <span class="s">&quot;PARIS&quot;</span><span class="o">));</span>
        <span class="c1">// 395 km in 2 hours =&gt; OK</span>
        <span class="n">ccOps</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">CreditCardOperation</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mf">348.85f</span><span class="o">,</span> <span class="n">beginTS</span><span class="o">.</span><span class="na">plusMinutes</span><span class="o">(</span><span class="mi">250</span><span class="o">).</span><span class="na">getMillis</span><span class="o">(),</span> <span class="s">&quot;LYON&quot;</span><span class="o">));</span>
        <span class="c1">// 395 km in 10 min =&gt; Fraud</span>
        <span class="n">ccOps</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">CreditCardOperation</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mf">125.85f</span><span class="o">,</span> <span class="n">beginTS</span><span class="o">.</span><span class="na">plusMinutes</span><span class="o">(</span><span class="mi">260</span><span class="o">).</span><span class="na">getMillis</span><span class="o">(),</span> <span class="s">&quot;PARIS&quot;</span><span class="o">));</span>

        <span class="k">return</span> <span class="n">env</span><span class="o">.</span><span class="na">fromCollection</span><span class="o">(</span><span class="n">ccOps</span><span class="o">).</span><span class="na">assignTimestampsAndWatermarks</span><span class="o">(</span><span class="k">new</span> <span class="n">BoundedOutOfOrdernessTimestampExtractor</span><span class="o">&lt;</span><span class="n">CreditCardOperation</span><span class="o">&gt;(</span><span class="n">Time</span><span class="o">.</span><span class="na">seconds</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">long</span> <span class="nf">extractTimestamp</span><span class="o">(</span><span class="n">CreditCardOperation</span> <span class="n">operation</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">operation</span><span class="o">.</span><span class="na">timestamp</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>


    <span class="cm">/**</span>
<span class="cm">     * Credit card operation</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">CreditCardOperation</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="n">UUID</span> <span class="n">operationId</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="n">user_id</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kt">float</span> <span class="n">amount</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kt">long</span> <span class="n">timestamp</span><span class="o">;</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="n">city</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">CreditCardOperation</span><span class="o">(</span><span class="kt">int</span> <span class="n">user_id</span><span class="o">,</span> <span class="kt">float</span> <span class="n">amount</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timestamp</span><span class="o">,</span> <span class="n">String</span> <span class="n">city</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">operationId</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">();</span>
            <span class="k">this</span><span class="o">.</span><span class="na">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">amount</span> <span class="o">=</span> <span class="n">amount</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">timestamp</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">city</span> <span class="o">=</span> <span class="n">city</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">StringBuffer</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">StringBuffer</span><span class="o">(</span><span class="s">&quot;CreditCardOperation{&quot;</span><span class="o">);</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;operationId=&quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">operationId</span><span class="o">);</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;, user_id=&quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">user_id</span><span class="o">);</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;, amount=&quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">amount</span><span class="o">);</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;, timestamp=&quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">timestamp</span><span class="o">);</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;, city=&#39;&quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">city</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;\&#39;&#39;</span><span class="o">);</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;}&#39;</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>


    <span class="cm">/**</span>
<span class="cm">     * Alert which will be pushed down the stream when a fraudulent operation is detected.</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Alert</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="n">UUID</span> <span class="n">operationId</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="n">user_id</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kt">float</span> <span class="n">amount</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kt">long</span> <span class="n">timestamp</span><span class="o">;</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="n">city</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Alert</span><span class="o">(</span><span class="n">UUID</span> <span class="n">operationId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">user_id</span><span class="o">,</span> <span class="kt">float</span> <span class="n">amount</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timestamp</span><span class="o">,</span> <span class="n">String</span> <span class="n">city</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">operationId</span> <span class="o">=</span> <span class="n">operationId</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">amount</span> <span class="o">=</span> <span class="n">amount</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">timestamp</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">city</span> <span class="o">=</span> <span class="n">city</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">static</span> <span class="n">Alert</span> <span class="nf">createFromOperation</span><span class="o">(</span><span class="n">CreditCardOperation</span> <span class="n">operation</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">Alert</span><span class="o">(</span><span class="n">operation</span><span class="o">.</span><span class="na">operationId</span><span class="o">,</span> <span class="n">operation</span><span class="o">.</span><span class="na">user_id</span><span class="o">,</span> <span class="n">operation</span><span class="o">.</span><span class="na">amount</span><span class="o">,</span> <span class="n">operation</span><span class="o">.</span><span class="na">timestamp</span><span class="o">,</span> <span class="n">operation</span><span class="o">.</span><span class="na">city</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">StringBuffer</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">StringBuffer</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">);</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;ALERT! Operation [&quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">operationId</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;] has been blocked. \t&quot;</span><span class="o">);</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;{user_id=&quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">user_id</span><span class="o">);</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;, amount=&quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">amount</span><span class="o">);</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;, timestamp=&quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">timestamp</span><span class="o">);</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;, city=&#39;&quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">city</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;\&#39;&#39;</span><span class="o">);</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;}&#39;</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>


    <span class="cm">/**</span>
<span class="cm">     * Calculate distance and travel speed between 2 credit card operations</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DistanceCalculator</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;&gt;</span> <span class="n">cities</span><span class="o">;</span>

        <span class="kd">static</span> <span class="o">{</span>
            <span class="n">cities</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
            <span class="n">cities</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;PARIS&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Tuple2</span><span class="o">&lt;&gt;(</span><span class="mf">48.8573</span><span class="o">,</span> <span class="mf">2.3493</span><span class="o">));</span>
            <span class="n">cities</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;LYON&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Tuple2</span><span class="o">&lt;&gt;(</span><span class="mf">45.7580</span><span class="o">,</span> <span class="mf">4.8330</span><span class="o">));</span>
            <span class="n">cities</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;BERLIN&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Tuple2</span><span class="o">&lt;&gt;(</span><span class="mf">52.5181</span><span class="o">,</span> <span class="mf">13.3896</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="cm">/**</span>
<span class="cm">         * Check if the the distance between 2 operations is reachable in the amount of time available during</span>
<span class="cm">         * these 2 operations</span>
<span class="cm">         *</span>
<span class="cm">         * @param operation1 the first credit card operation (oldest)</span>
<span class="cm">         * @param operation2 the last credit card operation (newest)</span>
<span class="cm">         * @param maxSpeed maximum speed in Km/h the person can travel at</span>
<span class="cm">         * @return True if the distance is reachable</span>
<span class="cm">         */</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isReachableDistance</span><span class="o">(</span><span class="n">CreditCardOperation</span> <span class="n">operation1</span><span class="o">,</span> <span class="n">CreditCardOperation</span> <span class="n">operation2</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxSpeed</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">float</span> <span class="n">timeInHours</span> <span class="o">=</span> <span class="o">((</span><span class="kt">float</span><span class="o">)</span> <span class="o">(</span><span class="n">operation2</span><span class="o">.</span><span class="na">timestamp</span> <span class="o">-</span> <span class="n">operation1</span><span class="o">.</span><span class="na">timestamp</span><span class="o">)</span> <span class="o">/</span> <span class="mi">3600000</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">distanceBetween</span><span class="o">(</span><span class="n">operation1</span><span class="o">.</span><span class="na">city</span><span class="o">,</span> <span class="n">operation2</span><span class="o">.</span><span class="na">city</span><span class="o">);</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">distance</span> <span class="o">/</span> <span class="n">timeInHours</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="n">maxSpeed</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/**</span>
<span class="cm">         * Calculate the distance in Km between 2 cities</span>
<span class="cm">         * @param cityCode1 first city</span>
<span class="cm">         * @param cityCode2 second city</span>
<span class="cm">         * @return distance in Km</span>
<span class="cm">         */</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">distanceBetween</span><span class="o">(</span><span class="n">String</span> <span class="n">cityCode1</span><span class="o">,</span> <span class="n">String</span> <span class="n">cityCode2</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="n">city1</span> <span class="o">=</span> <span class="n">cities</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">cityCode1</span><span class="o">);</span>
            <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="n">city2</span> <span class="o">=</span> <span class="n">cities</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">cityCode2</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">city1</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">city2</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="k">return</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">distance</span><span class="o">(</span><span class="n">city1</span><span class="o">.</span><span class="na">f0</span><span class="o">,</span> <span class="n">city1</span><span class="o">.</span><span class="na">f1</span><span class="o">,</span> <span class="n">city2</span><span class="o">.</span><span class="na">f0</span><span class="o">,</span> <span class="n">city2</span><span class="o">.</span><span class="na">f1</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="cm">/**</span>
<span class="cm">         * Calculate the distance between 2 geocoordinates</span>
<span class="cm">         * @param lat1 latitude geocoordinates 1</span>
<span class="cm">         * @param lon1 longitude geocoordinates 1</span>
<span class="cm">         * @param lat2 latitude geocoordinates 2</span>
<span class="cm">         * @param lon2 longitude geocoordinates 2</span>
<span class="cm">         * @return distance in Km</span>
<span class="cm">         */</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kt">double</span> <span class="nf">distance</span><span class="o">(</span><span class="kt">double</span> <span class="n">lat1</span><span class="o">,</span> <span class="kt">double</span> <span class="n">lon1</span><span class="o">,</span> <span class="kt">double</span> <span class="n">lat2</span><span class="o">,</span> <span class="kt">double</span> <span class="n">lon2</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">double</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">lon1</span> <span class="o">-</span> <span class="n">lon2</span><span class="o">;</span>
            <span class="kt">double</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">sin</span><span class="o">(</span><span class="n">deg2rad</span><span class="o">(</span><span class="n">lat1</span><span class="o">))</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="na">sin</span><span class="o">(</span><span class="n">deg2rad</span><span class="o">(</span><span class="n">lat2</span><span class="o">))</span> <span class="o">+</span> <span class="n">Math</span><span class="o">.</span><span class="na">cos</span><span class="o">(</span><span class="n">deg2rad</span><span class="o">(</span><span class="n">lat1</span><span class="o">))</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="na">cos</span><span class="o">(</span><span class="n">deg2rad</span><span class="o">(</span><span class="n">lat2</span><span class="o">))</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="na">cos</span><span class="o">(</span><span class="n">deg2rad</span><span class="o">(</span><span class="n">theta</span><span class="o">));</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">acos</span><span class="o">(</span><span class="n">dist</span><span class="o">);</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">rad2deg</span><span class="o">(</span><span class="n">dist</span><span class="o">);</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span> <span class="o">*</span> <span class="mi">111</span><span class="o">;</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">dist</span><span class="o">);</span>
        <span class="o">}</span>


        <span class="kd">private</span> <span class="kd">static</span> <span class="kt">double</span> <span class="nf">deg2rad</span><span class="o">(</span><span class="kt">double</span> <span class="n">deg</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">deg</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="na">PI</span> <span class="o">/</span> <span class="mf">180.0</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kd">static</span> <span class="kt">double</span> <span class="nf">rad2deg</span><span class="o">(</span><span class="kt">double</span> <span class="n">rad</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">rad</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">Math</span><span class="o">.</span><span class="na">PI</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre></div>



        </div>
      </div>
    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/3.1.0/anchor.min.js"></script>
    <script src="/page/js/flink.js"></script>

    <!-- Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-52545728-1', 'auto');
      ga('send', 'pageview');
    </script>

    <!-- Disqus -->
    
  </body>
</html>
